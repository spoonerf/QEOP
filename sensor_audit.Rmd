---
title: "QEOP Sensor Audit"
author: "Fiona Spooner"
date: "`r Sys.Date()`"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                     warning=FALSE, message=FALSE)
```

Libraries required:

```{r}
library(ggplot2)
library(dplyr)
library(here)
library(reader)
library(knitr)
library(anytime)
```

Reading in the data from the CE Tools Server:

```{r, eval=FALSE}

#dump<-read.table("qeop_dump_all.csv", fill=T, sep=",")

dump<-read.table("qeop_dump_2019_02_23.csv", fill=T, sep=",")

##adding in a column to identify each row with a sensor

dump$sensor<-NA
for (i in 1:15){
  start_id<-min(which(grepl( paste("qeop_batstore_",i, sep=""),dump[,1])))
  end_id<-max(which(grepl( paste("qeop_batstore_",i, sep=""),dump[,1])))
  dump[start_id:end_id,]$sensor<-paste("Sensor_",i,sep="")
  #print(i)
}

table(dump$sensor)


```

Removing redundant rows and the classification data as it is not relevant here:

```{r, eval = FALSE}
dump<-dump[,c(1,2,4,5,6,13,ncol(dump))]
dump<-dump[grepl("\t",dump[,1]),]
dump[,1]<-as.numeric(gsub("[\t(]","",dump[,1]))
dump[,3]<-as.numeric(gsub("[^0-9.]", "",  dump[,3]))
dump[,4]<-as.numeric(gsub("[^0-9.]", "",  dump[,4]))
dump[,5]<-gsub("[[:punct:]]", "", dump[,5])
dump[,5]<-substring(dump[,5],2)
dump[,6]<-as.numeric(gsub("[^0-9.]", "",  dump[,6]))

dump$sensor_no<-as.numeric(gsub("[^0-9.]", "",  dump$sensor))

colnames(dump)<-c("ID", "datetime", "prob_bat","prob_sp","species_class","call_time","sensor", "sensor_no")

dump$datetime<-as.POSIXct(dump$datetime,format="%Y-%m-%d %H:%M:%S")

dump$date<- as.Date(dump$datetime)

dump$species_class<-substring(dump$species_class, 2)

dump$time<- format(dump$datetime, "%H:%M:%S")

```


Calculating the number of detections per day for each sensor:

```{r, eval = FALSE}
library(dplyr)

days_active<-dump %>%
  dplyr::select(date, sensor_no)%>%
  group_by(date,sensor_no)%>%
  mutate(count = n())%>%
  distinct()%>%
  ungroup()

days_active$sensor_no<-as.factor(days_active$sensor_no)
days_active$server<-"CE Tools"


```

Most of the daily data are saved in individual folders, data between 24th October 2017 and 9th May 2018 are grouped together into 6 folders. This code creates new folders for each date between 24th Oct and 9th May

```{r}
lf<-list.files(paste(here::here(),"/data_archive/opensensors_Daniyar/qeoplogs_more", sep=""))

#subsetting folders with more than 10 chars
lf_gr<-lf[nchar(lf)>10]

#create dirs for all the missing dates - need to check which days are missing within this
fol_ds<-as.Date(unlist(strsplit(lf_gr, "_")))
mdays<-seq(min(fol_ds), max(fol_ds),by="days")

```

```{r, message=FALSE, eval=FALSE}
dir_maker<-function(mday){
  
  if (!dir.exists(paste(here::here(),"/data_archive/opensensors_Daniyar/qeoplogs_more/",mday, sep=""))){
    dir.create(path = paste(here::here(),"/data_archive/opensensors_Daniyar/qeoplogs_more/",mday, sep=""))
  }
    }
lapply(mdays, dir_maker)

```  

This code breaks up the .csv files by date and sensor, saves a file for each sensor within each date folder

```{r, eval=FALSE}


fold_split<-function(fol_name){
  
  fp<-paste(here::here(),"/data_archive/opensensors_Daniyar/qeoplogs_more/", fol_name, sep="" )
  fpl<-list.files(fp)
  lapply(fpl, file_split, fp = fp)
}

#here the anytime and anydate functions convert unix date formats to regular calendar dates and times

file_split<-function(file_name, fp){
  
  sensor_no<-as.numeric(gsub("[^0-9.]", "",  file_name))
  spl_csv<-read.csv(paste(fp,"/",file_name, sep=""))
  spl_csv$datetime<-anytime(spl_csv$timestamp/1000)#have to divide by 1000 as the numbers are stored to capture milliseconds
  spl_csv$date<-anydate(spl_csv$timestamp/1000)#have to divide by 1000 as the numbers are stored to capture milliseconds
  sp_df<-split(spl_csv, spl_csv$date)
  lapply(names(sp_df),function(x){write.csv(sp_df[[x]],file = paste(here::here(),"/data_archive/opensensors_Daniyar/qeoplogs_more/", sp_df[[x]]$date[1],"/","bat",sensor_no, ".csv", sep="" ),row.names = FALSE)})
  
}

lapply(lf_gr, fold_split)


```

Reading in the OpenSensors data, counting the number of rows in each file. Each row is a detection: 


```{r, eval=FALSE}

lf<-lf[nchar(lf) <=10]

sensor_count<-function(file, dir_id){
  
  sensor_no<-as.numeric(gsub("[^0-9.]", "",  file))
  count<-file.nrow(paste(here::here(), "/data_archive/opensensors_Daniyar/qeoplogs_more/", dir_id,"/", file,sep="")) #gives warning
  #count<-length(readr::count_fields(paste(here(), "/data_archive/opensensors_Daniyar/qeoplogs_more/", dir_id,"/", file,sep=""), tokenizer = readr::tokenizer_csv()))

  #remove file header if the file is a csv
  if (grepl("*csv", file)){
    count<-count - 1
  }

  out<-data.frame(dir_id,sensor_no, count)
  return(out)
  }

dir_count<-function(dir_id){
  files<-list.files(paste(here::here(), "/data_archive/opensensors_Daniyar/qeoplogs_more/", dir_id, sep=""))
  dir_out<-lapply(files, sensor_count, dir_id = dir_id)
  do.call("rbind", dir_out)
}

opensensors<-lapply(lf, dir_count)

open_df<-do.call("rbind", opensensors)
colnames(open_df)[1]<-"date"

open_df$server<-"Opensensors"

open_df$date<-as.Date(open_df$date)
open_df$sensor_no<-as.numeric(open_df$sensor_no)

```

Combining data from CE Tools and OpenSensors:

```{r, eval=FALSE}

all_sensors<-rbind(open_df, days_active)

all_sensors$sensor_no<-as.numeric(all_sensors$sensor_no)
#all_sensors<-all_sensors[complete.cases(all_sensors),]

min_date<-min(all_sensors$date)
max_date<-max(all_sensors$date)

all_dates<-seq(min_date, max_date, by="day")
all_df<-data.frame(rep(all_dates,15),rep(1:15, each = length(all_dates))) 
colnames(all_df)<-c("date", "sensor_no")


all_sensors_merge<-merge(all_df, all_sensors,by = c("date", "sensor_no" ) ,all=T)
#all_sensors_merge<-all_sensors_merge[complete.cases(all_sensors_merge),]

all_sensors_merge$sensor_no<-as.numeric(all_sensors_merge$sensor_no)

```


Additional information about the sensors from the documentation

```{r, eval=FALSE}

sensor_info<-read.csv("sensor_info.csv")

all_sensors_merge<-merge(all_sensors_merge, sensor_info, by="sensor_no")

```

Sensor 4 moved on 14th May 2018 so renaming data at this point onwards as 4_2

```{r, eval=FALSE}

# all_sensors_merge<-all_sensors_merge %>%
#  # filter(sensor_no == 4 & date >= as.Date("2018-05-14"))
#   mutate(sensor_no=replace(sensor_no, sensor_no == 4 & date >= as.Date("2018-05-14"), 4.5))

all_sensors_merge %>%
  filter(server == "Opensensors")%>%
  summarize(max_date = max(date))

#last date opensensors was working

all_sensors_merge<-all_sensors_merge %>%
  mutate(server = replace(server, date <= as.Date("2018-06-18"), "Opensensors" ), server = replace(server, date > as.Date("2018-06-18"), "CETools"))


#save(all_sensors_merge, file = "all_sensor_data_2017-07-12_2019-2019_01_14")
#save(all_sensors_merge, file = "all_sensor_data_2017_07_12-2019_02_23b")


```

```{r}

#load("all_sensor_data_2017-07-12_2019-2019_01_14")
#load("all_sensor_data_2017_07_12-2019_02_23")
load("all_sensor_data_2017_07_12-2019_02_23b")

```


```{r}

all_sensors_merge$deployment<-1


#changing the deployment of all sensor four records after 14th May 2018 to deploment 2
#Update all deployments here
#When did 5 move to Duncan's garden??
#6 might've moved?
#8 has or is due to be removed due to building work - is likely to be in the bin.

all_sensors_merge[all_sensors_merge$date >= as.Date("2018-05-14") & all_sensors_merge$sensor_no == 4,]<-all_sensors_merge %>%
  filter(date >= as.Date("2018-05-14") & sensor_no == 4)%>%
  mutate(deployment=replace(deployment, deployment==1, 2), Lat = replace(Lat, Lat==51.5367, 51.536553), Lon = replace(Lon, Lon==-0.0128, -0.013169))

##sensor 5 moved to muswelll hill on the 7th Aug 2018

all_sensors_merge[all_sensors_merge$date >= as.Date("2018-08-07") & all_sensors_merge$sensor_no == 5,]<-all_sensors_merge %>%
  filter(date >= as.Date("2018-08-07") & sensor_no == 5)%>%
  mutate(deployment=replace(deployment, deployment==1, 2), Lat = replace(Lat, Lat==51.5362, 51.590616), Lon = replace(Lon, Lon==-0.0127, -0.0139243))


all_sensors_merge$deployment_id<-paste(all_sensors_merge$sensor_no, all_sensors_merge$deployment, sep = ".")



```

####Figure 1: Plot of each sensor from `r min(all_sensors_merge$date)` to `r max(all_sensors_merge$date)`, the height of each column relates to the number of detections in each day:

```{r, echo =FALSE}
ggplot(all_sensors_merge, aes(x = date, y = deployment_id, group = deployment_id))+
  geom_line(color = "steelblue",aes(size = log10(count)))+
  scale_y_discrete(limits = c("15.1", "14.1", "13.1","12.1", "11.1","10.1", "9.1", "8.1"," 7.1","6.1","5.2","5.1","4.2","4.1","3.1","2.1","1.1"))+
  #scale_y_reverse(breaks = seq(1, length(unique(all_sensors_merge$deployment_id)), by = 1))+
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y")+
  theme_bw()+
  #theme(panel.background = element_blank())+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=18),
        legend.title=element_text(size=20))+
  labs(x = "Date", y = "Deployment", linetype = "test")+
  #scale_fill_continuous(breaks = c(0,1,2,3,4), labels = c("1","10", "100","1000","10000"), guide =guide_legend(title ="Detections\n(Log10)"))
  scale_size_continuous(breaks = c(0,1,2,3,4),labels = c("1","10","100", "1000", "10000"))+
  guides(size = guide_legend(title ="Detections"))

```

```{r, eval=FALSE, echo = FALSE}
ggplot(all_sensors_merge, aes(x = date, y = deployment_id, group = deployment_id))+
  geom_line(color = "steelblue",aes(size = count))+
  #scale_y_reverse(breaks = seq(1, 16, by = 1))+
  scale_y_discrete(limits = c("15.1", "14.1", "13.1","12.1", "11.1","10.1", "9.1", "8.1"," 7.1","6.1","5.2","5.1","4.2","4.1","3.1","2.1","1.1"))+
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y")+
  theme_bw()+
  #theme(panel.background = element_blank())+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=18),
        legend.title=element_text(size=20))+
  labs(x = "Date", y = "Deployment", linetype = "test")+
  #scale_fill_continuous(breaks = c(0,1,2,3,4), labels = c("1","10", "100","1000","10000"), guide =guide_legend(title ="Detections\n(Log10)"))
 # scale_size_continuous(breaks = c(0,1,2,3,4),labels = c("1","10","100", "1000", "10000"))+
  guides(size = guide_legend(title ="Detections"))

```



Creating a heuristic to identify when a sensor is down rather than there being no detections.

```{r, echo=FALSE}

break_finder<-function(x){
  nl_out<-rep(x, each = x)
  }

all_sensors_df<-NULL

for (i in 1:length(unique(all_sensors_merge$sensor_no))){

  test<-all_sensors_merge[all_sensors_merge$sensor_no == i, ]
  test<-arrange(test, date)
  rl<-rle(is.na(test$count))  
  bf_out<-sapply(rl$lengths, break_finder)
  test_na_run<-unlist(bf_out)
  test_na_run[!is.na(test$count)]<-NA
  test$days_inactive<-test_na_run
  all_sensors_df<-rbind(all_sensors_df,test)
  #print(i)
  
  }

all_sensors_df$inactive<-all_sensors_df$days_inactive

all_sensors_df$inactive_week[all_sensors_df$inactive <7]<-NA

all_sensors_df$inactive_week[all_sensors_df$inactive >=7]<-1

all_sensors_df$inactive_fnight[all_sensors_df$inactive <14]<-NA

all_sensors_df$inactive_fnight[all_sensors_df$inactive >=14]<-1

all_sensors_df$inactive_month[all_sensors_df$inactive <30]<-NA

all_sensors_df$inactive_month[all_sensors_df$inactive >=30]<-1

#write.csv(all_sensors_df, "all_sensors_daily.csv", row.names = FALSE)


```

####Figure 2: Red line shows where there have been no detections for seven continuous days

```{r, echo =FALSE}

ggplot(all_sensors_df, aes(x = date, y = deployment_id, group = deployment_id))+
  geom_line(color = "red", aes(x = date, y = deployment_id,size = log10(inactive_week)), alpha = 0.5)+
  geom_line(color = "steelblue",aes(size = log10(count)))+
    #scale_y_reverse(breaks = seq(1, 16, by = 1))+
  scale_y_discrete(limits = c("15.1", "14.1", "13.1","12.1", "11.1","10.1", "9.1", "8.1","7.1","6.1","5.2","5.1","4.2","4.1","3.1","2.1","1.1"))+
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y")+
  theme_bw()+
  #theme(panel.background = element_blank())+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=18),
        legend.title=element_text(size=20))+
  labs(x = "Date", y = "Deployment", linetype = "test")+
  #scale_fill_continuous(breaks = c(0,1,2,3,4), labels = c("1","10", "100","1000","10000"), guide =guide_legend(title ="Detections\n(Log10)"))
  scale_size_continuous(breaks = c(0,1,2,3,4),labels = c("1","10","100", "1000", "10000"))+
  guides(size = guide_legend(title ="Detections"))

```

```{r}
library(OpenStreetMap)

library(ggmap)
library(sp)

min_lat =  51.15 
max_lat = 51.70
min_lon = -0.123 
max_lon = 0.095

map <- openmap(c(max_lat,min_lon), c(min_lat,max_lon), zoom = NULL,type = "osm",mergeTiles = TRUE)


 all_active_df<-all_sensors_df %>%
  filter(deployment_id != "5.2")%>%
  group_by(deployment_id)%>%
  mutate(total_days = n_distinct(date),  inactive_days = sum(!is.na(inactive_week)),active_days = total_days - inactive_days, active_days_count = sum(na.omit(count)), average_daily_active_counts = active_days_count/active_days) %>%
  filter(is.na(inactive_week))%>%
  select(deployment_id, inactive_week, average_daily_active_counts, Lat, Lon, Habitat)%>%
  distinct()


# write.csv(all_active_df, "bat_activity_qeop.csv", row.names = FALSE)
 
 
```

```{r}
xy<-cbind(all_active_df$Lon, all_active_df$Lat)
S<-SpatialPoints(xy)
lnd<-bbox(S)
buff<-0.0015

lnd[1]<-lnd[1]-buff
lnd[2]<-lnd[2]-buff
lnd[3]<-lnd[3]+buff
lnd[4]<-lnd[4]+buff

lnd.b1 <- ggmap(get_map(location = lnd))

qeop<-lnd.b1 +  geom_point(aes(size = average_daily_active_counts, x = Lon, y = Lat, fill = Habitat), colour = "black",pch=21,data = all_active_df) + 
  scale_size_continuous(range=c(5, 15)) +
  labs(size = "Daily Average\nSensor Detections") + 
  theme_bw()+
  guides(fill=guide_legend(override.aes=list(size=5)))+
  xlab("Longitude")+
  ylab("Latitude")


png("QEOP_Map.png", width = 8, height = 8, units = 'in', res = 750)
qeop# Make plot
dev.off()



```
`
```{r}
xy<-cbind(all_active_df$Lon, all_active_df$Lat)
S<-SpatialPoints(xy)
lnd<-bbox(S)
buff<-0.0015

lnd[1]<-lnd[1]-buff
lnd[2]<-lnd[2]-buff
lnd[3]<-lnd[3]+buff
lnd[4]<-lnd[4]+buff

lnd.b1 <- ggmap(get_map(location = lnd))

qeop<-lnd.b1 +  geom_point(aes(size = average_daily_active_counts, x = Lon, y = Lat, fill = Habitat), colour = "black",pch=21,data = all_active_df) + 
  scale_size_continuous(range=c(5, 15)) +
  labs(size = "Daily Average\nSensor Detections") + 
  theme_bw()+
  guides(fill=guide_legend(override.aes=list(size=5)))+
  xlab("Longitude")+
  ylab("Latitude")


png("QEOP_Map.png", width = 8, height = 8, units = 'in', res = 750)
qeop# Make plot
dev.off()

```

####Figure 3: Red line shows where there have been no detections for fourteen continuous days

```{r, echo = FALSE}

ggplot(all_sensors_df, aes(x = date, y = deployment_id, group = deployment_id))+
  geom_line(color = "red", aes(x = date, y = deployment_id, size = log10(inactive_fnight)), alpha = 0.5)+
  geom_line(color = "steelblue",aes(size = log10(count)))+
  scale_y_discrete(limits = c("15.1", "14.1", "13.1","12.1", "11.1","10.1", "9.1", "8.1","7.1","6.1","5.2","5.1","4.2","4.1","3.1","2.1","1.1"))+
  #scale_y_reverse(breaks = seq(1, 16, by = 1))+
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y")+
  theme_bw()+
  #theme(panel.background = element_blank())+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=18),
        legend.title=element_text(size=20))+
  labs(x = "Date", y = "Deployment.", linetype = "test")+
  #scale_fill_continuous(breaks = c(0,1,2,3,4), labels = c("1","10", "100","1000","10000"), guide =guide_legend(title ="Detections\n(Log10)"))
  scale_size_continuous(breaks = c(0,1,2,3,4),labels = c("1","10","100", "1000", "10000"))+
  guides(size = guide_legend(title ="Detections"))

```

####Figure 4: Red line shows where there have been no detections for thirty continuous days

```{r, echo = FALSE}

ggplot(all_sensors_df, aes(x = date, y = deployment_id, group = deployment_id))+
  geom_line(color = "red", aes(x = date, y = deployment_id,size = log10(inactive_month)), alpha = 0.5)+
  geom_line(color = "steelblue",aes(size = log10(count)))+
  scale_y_discrete(limits = c("15.1", "14.1", "13.1","12.1", "11.1","10.1", "9.1", "8.1","7.1","6.1","5.2","5.1","4.2","4.1","3.1","2.1","1.1"))+
  #scale_y_reverse(breaks = seq(1, 16, by = 1))+
  scale_x_date(date_breaks = "1 month", date_labels = "%m-%Y")+
  theme_bw()+
  #theme(panel.background = element_blank())+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=18),
        legend.title=element_text(size=20))+
  labs(x = "Date", y = "Sensor No.", linetype = "test")+
  #scale_fill_continuous(breaks = c(0,1,2,3,4), labels = c("1","10", "100","1000","10000"), guide =guide_legend(title ="Detections\n(Log10)"))
  scale_size_continuous(breaks = c(0,1,2,3,4),labels = c("1","10","100", "1000", "10000"))+
  guides(size = guide_legend(title ="Detections"))

```




```{r, echo = FALSE, eval = FALSE}
kable(
  all_sensors_merge %>%
  group_by(deployment_id, server) %>%
  filter(!is.na(count))%>%
  summarise(first_date = min(date), last_date = max(date)))

```



```{r, eval= FALSE , echo = FALSE}

library(stringr)

os_dirs<-list.dirs(here::here("data_archive/opensensors_Daniyar/qeoplogs_more/"))

getmode<-function(v){
  uniqv<-unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

#getting rid of the folders with multiple dates in - removing anything which doesn't have the modal average number of characters. Bit shaky but okay for now.
os_dirs<-os_dirs[nchar(os_dirs)==getmode(nchar(os_dirs))]


os_tool_out<-function(os_dir){
  file_list<-list.files(os_dir)
  
  for (file in file_list){
      print(os_dir)
      print(file)
    
      if(grepl(".csv", file)){
         df_temp = read.table(paste(os_dir,"/", file, sep=""), sep=",", header = T, stringsAsFactors = F)
         df_temp$sensor_id<-as.numeric(gsub("\\D", "", file))
         df_temp$timestamp<-as.numeric(as.character(df_temp$timestamp))
         df_temp$timestamp<-anytime(df_temp$timestamp/1000)
         
         df_out<-df_temp[,c("sensor_id","timestamp", "call_time", "prob_bat", "c1", "p1")]
         
      } 
    
      if (grepl(".txt", file)) {
         #df_temp = read.table(paste(ce_dir,"/", file, sep=""))
         df_temp = read.csv(paste(os_dir,"/", file, sep=""), header = FALSE)
         cols<-paste("V", 1:ncol(df_temp), sep="")
         df_temp$x <- apply( df_temp[ , cols ] , 1 , paste , collapse = "." )
         
         spl<-strsplit(df_temp$x, " ")
         
         get_neat_os_data<-function(x){
           
             sensor_id<-gsub("[^0-9]", "", x[which(grepl("sensor_bat",x))])
             
             timestamp<-gsub("[^0-9.]", "",paste(x[which(x== "timestamp:")+1],x[which(x== "timestamp:")+2],x[which(x== "timestamp:")+3],x[which(x== "timestamp:")+4], x[which(x== "timestamp:")+5], x[which(x== "timestamp:")+6], sep=""))
             
             timestamp<-toString(strsplit(timestamp, "[.]")[[1]][2:7])
             
             timestamp<-as.POSIXct(timestamp, format = "%Y, %m, %d, %H, %M, %S")  
             call_time<-x[which(x == "call_time:")+1]
             call_time<-as.numeric(substr(call_time, 1, nchar(call_time)-1)) 
             
             prob_bat<- x[which(x == "prob_bat:")+1]
             prob_bat<-as.numeric(substr(prob_bat, 1, nchar(prob_bat)-1))  
              
             genus<-gsub("'","",x[which(x == "c1:")+1])
             spec<-gsub("[[:punct:]]","",x[which(x == "c1:")+2])
             
             c1<-paste(genus, spec, sep = " ")
             
             p1<- x[which(x == "p1:")+1]
             p1<-as.numeric(substr(p1, 1, nchar(p1)-1)) 
             
             df_out<-data.frame(sensor_id,timestamp, call_time, prob_bat, c1, p1)
             colnames(df_out)<-c("sensor_id","timestamp", "call_time", "prob_bat", "c1", "p1")
             print(df_out)
         return(df_out)
         }
         
         df_out<-lapply(spl,get_neat_os_data)
         df_out<-do.call("rbind", df_out)
         
           }
         #print(os_dir)
         #print(file)
         df = rbind(df, df_out)
         #print(paste(os_dir, file, sep="/"))
        
          }
  
  return(df)
}

df<-data.frame()

os_df<-lapply(os_dirs, os_tool_out)



colnames <- c("sensor_id","timestamp", "call_time", "prob_bat", "c1", "p1") 


# for (i in seq_along(os_df)){
#   
#   if(length(colnames(os_df[[i]])) > 0){
#   colnames(os_df[[i]]) <- colnames
#   } else{
#     os_df[[i]]<-NULL
#   }
#   print(i)
#   }


os_sens_df<-do.call("rbind", os_df)

os_sens_df$c1<-gsub('[[:punct:] ]+',' ',os_sens_df$c1)

os_sens_df$c1<-str_trim(os_sens_df$c1)


os_sens_df$date<-as.Date(os_sens_df$timestamp)

os_sens_df$time<-format(os_sens_df$timestamp, "%H:%M:%S")




#write.csv(os_sens_df, "all_sensors_os_records_May_2019.csv", row.names = FALSE)

```

```{r, eval=FALSE, echo = FALSE}

os_sens_df<-read.csv("all_sensors_os_records_May_2019.csv")

ce_sensors<-data.frame(dump[,c("sensor","datetime","call_time","prob_bat","species_class","prob_sp" , "date", "time")])
colnames(ce_sensors)<-colnames(os_sens_df)
ce_sensors$sensor_id<- gsub("[^0-9.]", "", ce_sensors$sensor_id)

#write.csv(ce_sensors, "all_sensors_ce_records.csv", row.names = FALSE)

```


Adding a month column and formatting data for plotting record data over the year
```{r}
library(chron)
library(scales)
library(lubridate)
library(ggplot2)

ce_sens_df<-read.csv("all_sensors_ce_records.csv")
os_sens_df<-read.csv("all_sensors_os_records_May_2019.csv")

ce_sens_df$call_time<-as.numeric(as.character(ce_sens_df$call_time))

all_sens_df<-rbind(ce_sens_df, os_sens_df)

sensor_info<-read.csv("sensor_info.csv")


all_sens_info<-merge(all_sens_df, sensor_info, by.x = "sensor_id", by.y = "sensor_no")


```


Adding deployment information column

```{r, echo = FALSE}


# all_sensors_merge<-all_sensors_merge %>%
#  # filter(sensor_no == 4 & date >= as.Date("2018-05-14"))
#   mutate(sensor_no=replace(sensor_no, sensor_no == 4 & date >= as.Date("2018-05-14"), 4.5))

all_sens_info$deployment<-1


#changing the deployment of all sensor four records after 14th May 2018 to deploment 2
#Update all deployments here
#When did 5 move to Duncan's garden??
#6 might've moved?
#8 has or is due to be removed due to building work - is likely to be in the bin.

all_sens_info[as.Date(as.character(all_sens_info$date)) > as.Date(as.character("2018-05-14")) & all_sens_info$sensor_id == 4,]<-all_sens_info %>%
  filter(as.Date(as.character(date)) > as.Date("2018-05-14") & sensor_id == 4)%>%
  mutate(deployment=replace(deployment, deployment==1, 2), Lat = replace(Lat, Lat==51.5367, 51.536553), Lon = replace(Lon, Lon==-0.0128, -0.013169))

all_sens_info %>%
filter(sensor_id == 4 & date >= as.Date("2018-05-14"))

all_sens_info[as.Date(as.character(all_sens_info$date)) > as.Date("2018-08-07") & all_sens_info$sensor_id == 5,]<-all_sens_info %>%
  filter(as.Date(as.character(date)) > as.Date("2018-08-07") & sensor_id == 5)%>%
  mutate(deployment=replace(deployment, deployment==1, 2), Lat = replace(Lat, Lat==51.5362, 51.590616), Lon = replace(Lon, Lon==-0.0127, -0.0139243), Habitat = replace(Habitat, Habitat == "Grassland", "Duncan's Garden" ))


all_sens_info$deployment_id<-paste(all_sens_info$sensor_id, all_sens_info$deployment, sep = ".")

```

```{r, echo = FALSE}
all_sens_info$month<-months.Date(as.Date(all_sens_info$date))

all_sens_info$month<-factor(all_sens_info$month, levels = month.name)

all_sens_info$timestamp<-as.POSIXct(all_sens_info$timestamp)

t <- strftime(all_sens_info$timestamp, format="%H:%M:%S")

all_sens_info$time<-as.POSIXct(t, format="%H:%M:%S")

all_sens_info<-all_sens_info[complete.cases(all_sens_info),]


all_sens_info$Habitat<-as.character(all_sens_info$Habitat)

#shifting anything before 6pm forwrd by a day
#all_sens_info[hour(all_sens_info$timestamp) < 18, ]$time<-all_sens_info[hour(all_sens_info$timestamp) < 18, ]$time +days(1)

```

```{r, eval = FALSE}
all_sens_info_night<-all_sens_info[all_sens_info$time < as.POSIXct(paste(Sys.Date()+1, " 06:00:00 GMT", sep="")),]

all_sens_info_night <-all_sens_info_night %>%
  group_by(sensor_id, month) %>%
  mutate(count = n())%>%
  ungroup

give.n <- function(x){
   #return(c(y = as.POSIXct(paste(Sys.Date(), "18:00:00", sep=" "), format = "%Y-%m-%d %H:%M:%S"), label = length(x)))
  return(c(y = min(x), label = length(x)))
}

ggplot(all_sens_info_night, aes(x = month, y = time))+
  geom_boxplot(aes(fill=Habitat))+
  facet_wrap(.~as.numeric(deployment_id))+
  labs(x = "Month", y = "Time")+
  #stat_summary(fun.data = give.n, geom = "text")+
  scale_x_discrete(labels=month.abb[c(1,4,7,10)], breaks = c("January", "April", "July", "October")) +
  theme_bw()

```


```{r}

# all_sensors_df$month<-months.Date(as.Date(all_sensors_df$date))
# all_sensors_df$month<-factor(all_sensors_df$month, levels = month.name)

all_sens_info$date_ch<-as.character(all_sens_info$date)
all_sens_info$c1<-as.character(all_sens_info$c1)
all_sens_info$month_ch<-all_sens_info$month
```

```{r}
all_sens_info<-all_sens_info %>%
  group_by(date_ch)%>%
  mutate(count_date = n())%>%
  ungroup()

#write.csv(all_sens_info, "all_sensors_all_calls.csv", row.names = FALSE)

```

####Figure 5: Distribution of total daily calls for each month 

```{r}
ggplot(all_sens_info, aes(x = all_sens_info$month, y = log10(all_sens_info$count_date)))+
  geom_boxplot()+
  labs(x = "Month", y = "Log10 Daily Calls")+
  scale_x_discrete(labels=month.abb) +
  theme_bw()+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

```


Distribution of daily calls over the year by species - some of the species names are spelt multiple ways, some wrong, some right.

```{r}
all_sens_info<-all_sens_info %>%
  group_by(sensor_id,c1, date)%>%
  mutate(count_sp = n())%>%
  ungroup()

# all_sens_info<-all_sens_info %>%
#   mutate(c1 = replace(c1, c1 == "Nytalus leisleri", "Nyctalus leisleri"))%>%
#   mutate(c1 = replace(c1, c1 == "Nytalus notula", "Nyctalus noctula"))%>%
#   mutate(c1 = replace(c1, c1 == "Pleotus auritus", "Plecotus auritus"))%>%
#   mutate(c1 = replace(c1, c1 == "Pleotus austriaus", "Plecotus austriacus"))
```

####Figure 6: Distribution of total daily calls for each month, by species.  

```{r}
ggplot(all_sens_info, aes(x = month_ch, y = log10(count_sp)))+
  geom_boxplot()+
  facet_wrap(.~c1)+
  labs(x = "Month", y = "Log10 Daily Calls")+
  scale_x_discrete(labels=month.abb) +
  theme_bw()+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))
```


####Figure 7: Distribution of total daily calls for each month, by genus.  

```{r}

all_sens_info$g1<-vapply(strsplit(as.character(all_sens_info$c1)," "), `[`, 1, FUN.VALUE=character(1))

all_sens_info<-all_sens_info %>%
  group_by(sensor_id,g1, date)%>%
  mutate(count_gen = n())%>%
  ungroup()



ggplot(all_sens_info, aes(x = month_ch, y = log10(count_gen)))+
  geom_boxplot()+
  facet_wrap(.~g1)+
  labs(x = "Month", y = "Log10 Daily Calls")+
  scale_x_discrete(labels=month.abb) +
  theme_bw()+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        strip.text.x = element_text(size = 20))
```

```{r}

all_sensors_active<-merge(all_active_df[, c("date", "deployment_id", "inactive", "inactive_week")], all_sens_info, by = c("date", "deployment_id"))


all_sensors_active %>%
  filter(is.na(inactive_week))%>%
ggplot(aes(x = month_ch, y = log10(count_gen)))+
  geom_boxplot()+
  facet_wrap(.~as.factor(g1))+
  labs(x = "Month", y = "Log10 Daily Calls")+
  scale_x_discrete(labels=month.abb) +
  theme_bw()+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        strip.text.x = element_text(size = 20))

```



```{r}

ggplot(all_sens_info, aes(p1, group = c1))+
  geom_histogram()+
  #scale_y_continuous(trans = "log1p")+
  #ylim(0,5000)+
  facet_wrap(~c1)



ggplot(all_sens_info, aes(p1, group = c1))+
  geom_histogram()+
  #scale_y_log10()+
  scale_y_continuous(breaks=c(1,10,100,1000,10000,100000, 1000000),trans = "log1p")+
  #ylim(0,5000)+
  ylab("Count (log1p)")+
  xlab("Classification Probability")+
  facet_wrap(~c1)



```
####Figure 8: Distribution of total daily calls for each month, by habitat type.

```{r}
all_sens_info<-all_sens_info %>%
  group_by(sensor_id,Habitat, date)%>%
  mutate(count_hab = n())%>%
  ungroup()

ggplot(all_sens_info, aes(x = month_ch, y = log10(count_hab)))+
  geom_boxplot()+
  facet_wrap(.~Habitat)+
  labs(x = "Month", y = "Log10 Daily Calls")+
  scale_x_discrete(labels=month.abb) +
  theme_bw()+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 18),
        axis.text.x = element_text(size = 14, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))
```

####Figure 9: Distribution of total daily calls for each month, by deployment.

```{r}
all_sens_info<-all_sens_info %>%
  group_by(deployment_id, date)%>%
  mutate(count_sens = n())%>%
  ungroup()

ggplot(all_sens_info, aes(x = month_ch, y = log10(count_sens)))+
  geom_boxplot()+
  facet_wrap(.~as.numeric(deployment_id))+
  labs(x = "Month", y = "Log10 Daily Calls")+
  scale_x_discrete(labels=month.abb) +
  theme_bw()+
  theme(axis.text.y = element_text(lineheight = 0.5 , size = 12),
        axis.text.x = element_text(size = 12, angle= 45, hjust = 1),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))

```



```{r,echo = FALSE, eval = FALSE}
library(suncalc)
library(lubridate)

QEOP_loc<-cbind(mean(unique(all_sens_info$Lat)), mean(unique(all_sens_info$Lon)))


suntimes<-getSunlightTimes(lat = QEOP_loc[1], lon = QEOP_loc[2], date = unique(as.Date(all_sens_info$date)), keep = c("sunrise", "sunset"), tz = "UTC")

suntimes$date<-as.Date(suntimes$date)

suntimes$sunrise<-if_else(suntimes$date < as.Date("2017-10-29") | (suntimes$date > as.Date("2018-03-24") & suntimes$date < as.Date("2018-10-28")), suntimes$sunrise - 3600 , suntimes$sunrise)

suntimes$sunset<-if_else(suntimes$date < as.Date("2017-10-29") | (suntimes$date > as.Date("2018-03-24") & suntimes$date < as.Date("2018-10-28")), suntimes$sunset - 3600 , suntimes$sunset)


suntimes$date<-as.Date(suntimes$date)
all_sens_info$date<-as.Date(all_sens_info$date)

df<-merge(suntimes, all_sens_info, by="date")
df$sunrise <- strftime(df$sunrise, format="%H:%M:%S")
df$sunrise <- as.POSIXct(df$sunrise, format="%H:%M:%S")

ggplot(df, aes(x = date, y = sunrise))+
  #geom_boxplot(aes(fill=Habitat))+ 
  geom_line()

#df$sunset_diff<-  as.numeric(df$sunset - df$timestamp)

#hist(df$sunset_diff/3600, main = "", xlab = "Hours Since Sunset")


```










```{r, eval = FALSE, echo = FALSE}

###need to sort out sensor four 

library(leaflet)
library(htmltools)
library(mapview)

bat = makeIcon("bat.png", 36, 36)

s1<-dplyr::filter(all_sens_info, sensor_id == 1)

file_1<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_1.png'
file_2<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_2.png'
file_3<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_3.png'
file_4_1<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_4_1.png'
#file_4_2<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_4_1.png'
file_5<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_5.png'
file_6<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_6.png'
file_7<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_7.png'
file_8<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_8.png'
file_9<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_9.png'
file_10<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_10.png'
file_11<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_11.png'
file_12<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_12.png'
file_13<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_13.png'
file_14<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_14.png'
file_15<-'D:/Fiona/QEOP/data_archive/sensor_pics/sensor_15.png'

content_1 <- paste(sep = "<br/>",
               paste0("<b>Sensor 1: </b>"),
               paste0("<b>Lamp post ID: </b>", "CP03"),
               paste0("<b>Direction: </b>", "Towards grass"),
               paste0("<b>Habitat: </b>", "Parkland"),
               paste0("<b>Lighting: </b>", "Not directly onto grass, but directed into trees on path."),
               paste0("<b>Light levels (Lux): : </b>", "On path 0.08; on grass 0.01."))

content_2 <- paste(sep = "<br/>",
               paste0("<b>Sensor 2: </b>"),
               paste0("<b>Lamp post ID: </b>", "TC472"),
               paste0("<b>Direction: </b>", "Facing towards the river"),
               paste0("<b>Habitat: </b>", "Water"))

content_3 <- paste(sep = "<br/>",
               paste0("<b>Sensor 3: </b>"),
               paste0("<b>Lamp post ID: </b>", "C92A"),
               paste0("<b>Direction: </b>", "Towards grass bank, away from road"),
               paste0("<b>Habitat: </b>", "Grassland"))

content_4_1 <- paste(sep = "<br/>",
               paste0("<b>Sensor 4: </b>"),
               paste0("<b>Lamp post ID: </b>", "TC327"),
               paste0("<b>Direction: </b>", "Towards allotments"),
               paste0("<b>Habitat: </b>", "Grassland"))

content_5 <- paste(sep = "<br/>",
               paste0("<b>Sensor 5: </b>"),
               paste0("<b>Lamp post ID: </b>", "H"),
               paste0("<b>Direction: </b>", "Away from river"),
               paste0("<b>Habitat: </b>", "Grassland"),
               paste0("<b>Lighting: </b>", "Light directed onto path. Spill onto river. Spotlight, probably not LED."),
               paste0("<b>Light levels (Lux): : </b>", "0.04-0.09 on path under light, 0.014 behind light on grass verge."))

content_6 <- paste(sep = "<br/>",
               paste0("<b>Sensor 6: </b>"),
               paste0("<b>CCTV post: </b>", "H"),
               paste0("<b>Direction: </b>", "Towards river"),
               paste0("<b>Habitat: </b>", "Water"))

content_7 <- paste(sep = "<br/>",
               paste0("<b>Sensor 7: </b>"),
               paste0("<b>Lamp post: </b>", "CA13"),
               paste0("<b>Direction: </b>", "Towards river"),
               paste0("<b>Habitat: </b>", "Water"))

content_8 <- paste(sep = "<br/>",
               paste0("<b>Sensor 8: </b>"),
               paste0("<b>Lamp post: </b>", "TC244"),
               paste0("<b>Direction: </b>", "Towards river"),
               paste0("<b>Habitat: </b>", "Water"))

content_9 <- paste(sep = "<br/>",
               paste0("<b>Sensor 9: </b>"),
               paste0("<b>Lamp post: </b>", "LS61"),
               paste0("<b>Direction: </b>", "Towards trees away from path"),
               paste0("<b>Habitat: </b>", "Trees"))

content_10 <- paste(sep = "<br/>",
               paste0("<b>Sensor 10: </b>"),
               paste0("<b>Lamp post: </b>", "TC508"),
               paste0("<b>Direction: </b>", "Towards stadium across grass and tree area"),
               paste0("<b>Habitat: </b>", "Grassland"),
               paste0("<b>Lighting: </b>", "Grassland area reasonably dark."),
               paste0("<b>Light levels (Lux): : </b>", "0.05 on path. 0.02 immediately behind lamppost on grass. <br> 0.01 4m behind lamppost on grass. 0.003 10m behind lamppost on grass. "))

content_11 <- paste(sep = "<br/>",
               paste0("<b>Sensor 11: </b>"),
               paste0("<b>Lamp post: </b>", "CDM3832"),
               paste0("<b>Direction: </b>", "Facing across grass mound away from trees"),
               paste0("<b>Habitat: </b>", "Parkland"))

content_12 <- paste(sep = "<br/>",
               paste0("<b>Sensor 12: </b>"),
               paste0("<b>Lamp post: </b>", "LS64"),
               paste0("<b>Direction: </b>", "Facing south, across tree and grass area"),
               paste0("<b>Habitat: </b>", "Grassland"),
               paste0("<b>Lighting: </b>", "Continuous brightness to the side"),
               paste0("<b>Light levels (Lux): : </b>", "0.036 on track. 0.02 directly behind lamppost on grass.<br> 0.012 3m behind. 0.008 5m behind. 0.003 on flat grass, 10m. 15-20m to edge if spill."))

content_13 <- paste(sep = "<br/>",
               paste0("<b>Sensor 13: </b>"),
               paste0("<b>Lamp post: </b>", "LD07"),
               paste0("<b>Direction: </b>", "Facing towards the grass away from the path"),
               paste0("<b>Habitat: </b>", "Grassland"))

content_14 <- paste(sep = "<br/>",
               paste0("<b>Sensor 14: </b>"),
               paste0("<b>Lamp post: </b>", "LS85"),
               paste0("<b>Direction: </b>", "Towards trees"),
               paste0("<b>Habitat: </b>", "Trees"),
               paste0("<b>Lighting: </b>", "Very dark on other side of bank"),
               paste0("<b>Light levels (Lux): : </b>", "0.051 directly underneath. 0.045 beside.<br> 0.025 2m behind lamppost on grass. 0.016 5m behind. 0.006 7m behind."))

content_15 <- paste(sep = "<br/>",
               paste0("<b>Sensor 15: </b>"),
               paste0("<b>Lamp post: </b>", "LS31"),
               paste0("<b>Direction: </b>", "Facing towards the bridge across the grass area"),
               paste0("<b>Habitat: </b>", "Parkland"))

m <- leaflet() %>%
  addTiles() %>%  
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 1, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 1, ]$Lat[1], popup=popupImage(file_1), icon = bat, label =  htmltools::HTML(content_1), labelOptions = labelOptions(direction = "bottom"))%>%  
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 2, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 2, ]$Lat[1], popup=popupImage(file_2), icon = bat, label =  htmltools::HTML(content_2), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 3, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 3, ]$Lat[1], popup=popupImage(file_3), icon = bat, label =  htmltools::HTML(content_3), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 4, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 4, ]$Lat[1], popup=popupImage(file_4_1), icon = bat, label =  htmltools::HTML(content_4_1), labelOptions = labelOptions(direction = "bottom")) %>%
    # addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 4, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 4, ]$Lat[1], popup=popupImage(file_4_2), icon = bat, label =  htmltools::HTML(content_4_2), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 5, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 5, ]$Lat[1], popup=popupImage(file_5), icon = bat, label =  htmltools::HTML(content_5), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 6, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 6, ]$Lat[1], popup=popupImage(file_6), icon = bat, label =  htmltools::HTML(content_6), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 7, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 7, ]$Lat[1], popup=popupImage(file_7), icon = bat, label =  htmltools::HTML(content_7), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 8, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 8, ]$Lat[1], popup=popupImage(file_8), icon = bat, label =  htmltools::HTML(content_8), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 9, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 9, ]$Lat[1], popup=popupImage(file_9), icon = bat, label =  htmltools::HTML(content_9), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 10, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 10, ]$Lat[1], popup=popupImage(file_10), icon = bat, label =  htmltools::HTML(content_10), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 11, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 11, ]$Lat[1], popup=popupImage(file_11), icon = bat, label =  htmltools::HTML(content_11), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 12, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 12, ]$Lat[1], popup=popupImage(file_12), icon = bat, label =  htmltools::HTML(content_12), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 13, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 13, ]$Lat[1], popup=popupImage(file_13), icon = bat, label =  htmltools::HTML(content_13), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 14, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 14, ]$Lat[1], popup=popupImage(file_14), icon = bat, label =  htmltools::HTML(content_14), labelOptions = labelOptions(direction = "bottom")) %>%
  addMarkers(lng=all_sens_info[all_sens_info$sensor_id == 15, ]$Lon[1], lat=all_sens_info[all_sens_info$sensor_id == 15, ]$Lat[1], popup=popupImage(file_15), icon = bat, label =  htmltools::HTML(content_15), labelOptions = labelOptions(direction = "bottom"))

m

```



